type Direction = "Up" | "Down" | "Left" | "Right" | "Invalid";

function print2DArray<T>(arr: T[][]): void {
  for (let i = 0; i < arr.length; i++) {
    console.log(`Row ${i}: ${arr[i].join("| ")}`);
  }
  console.log();
}

const directionToSymbol: Record<Direction, string> = {
  Up: "^",
  Down: "v",
  Left: "<",
  Right: ">",
  Invalid: "?",
};

function assertUnreachable(x: never) {
  throw new Error("Exhaustive switch in typescript! :)");
}

const create2DArray = (input: string) => {
  const lines = input.split("\n");
  const grid: string[][] = [];
  for (let i = 0; i < lines.length; i++) {
    grid.push(lines[i].split(""));
  }
  return grid;
};

const locateGuard = (grid: string[][]): [number, number, Direction] => {
  for (let i = 0; i < grid.length; i++) {
    for (let j = 0; j < grid[i].length; j++) {
      if (grid[i][j] === "^") return [i, j, "Up"];
      if (grid[i][j] === "v") return [i, j, "Down"];
      if (grid[i][j] === "<") return [i, j, "Left"];
      if (grid[i][j] === ">") return [i, j, "Right"];
    }
  }
  return [-1, -1, "Invalid"];
};

const isWithinBounds = (x: number, y: number, grid: string[][]) => {
  return x >= 0 && x < grid.length && y >= 0 && y < grid[0].length;
};

const turnDirecton = (direction: Direction): Direction => {
  switch (direction) {
    case "Up":
      return "Right";
    case "Down":
      return "Left";
    case "Left":
      return "Up";
    case "Right":
      return "Down";
    case "Invalid":
      return "Invalid";
  }
};

const countVisited = (grid: string[][]) => {
  let counter = 0;
  for (let i = 0; i < grid.length; i++) {
    for (let j = 0; j < grid[i].length; j++) {
      if (grid[i][j] === "X") counter++;
    }
  }
  return counter;
};

export const day06a = (): number => {
  const grid = create2DArray(input);
  let [x, y, direction] = locateGuard(grid);
  let shouldContinue = true;

  while (shouldContinue) {
    shouldContinue = false;
    switch (direction) {
      case "Up":
        while (isWithinBounds(x - 1, y, grid)) {
          if (grid[x - 1][y] === "#") {
            direction = turnDirecton(direction);
            grid[x][y] = directionToSymbol[direction];
            shouldContinue = true;
            break;
          }
          grid[x - 1][y] = directionToSymbol[direction];
          grid[x][y] = "X";
          x--;
        }
        break;
      case "Down":
        while (isWithinBounds(x + 1, y, grid)) {
          if (grid[x + 1][y] === "#") {
            direction = turnDirecton(direction);
            grid[x][y] = directionToSymbol[direction];
            shouldContinue = true;
            break;
          }
          grid[x + 1][y] = directionToSymbol[direction];
          grid[x][y] = "X";
          x++;
        }
        break;
      case "Left":
        while (isWithinBounds(x, y - 1, grid)) {
          if (grid[x][y - 1] === "#") {
            direction = turnDirecton(direction);
            grid[x][y] = directionToSymbol[direction];
            shouldContinue = true;
            break;
          }
          grid[x][y - 1] = directionToSymbol[direction];
          grid[x][y] = "X";
          y--;
        }
        break;
      case "Right":
        while (isWithinBounds(x, y + 1, grid)) {
          if (grid[x][y + 1] === "#") {
            direction = turnDirecton(direction);
            grid[x][y] = directionToSymbol[direction];
            shouldContinue = true;
            break;
          }
          grid[x][y + 1] = directionToSymbol[direction];
          grid[x][y] = "X";
          y++;
        }
        break;
      case "Invalid":
        break;
      default:
        assertUnreachable(direction);
    }
  }

  const [finalX, finalY] = locateGuard(grid);
  grid[finalX][finalY] = "X";
  print2DArray(grid);
  return countVisited(grid);
};

function copy2DArray(arr: string[][]): string[][] {
  return arr.map((row) => [...row]);
}

const isInLoop = (grid: string[][]): boolean => {
  const temp = copy2DArray(grid);
  const visitedPositions: Set<string> = new Set();
  let [x, y, direction] = locateGuard(temp);
  let shouldContinue = true;

  while (shouldContinue) {
    shouldContinue = false;
    switch (direction) {
      case "Up":
        while (isWithinBounds(x - 1, y, temp)) {
          if (visitedPositions.has(`${x},${y} -> ${direction}`)) return true;
          visitedPositions.add(`${x},${y} -> ${direction}`);
          if (temp[x - 1][y] === "#") {
            direction = turnDirecton(direction);
            temp[x][y] = directionToSymbol[direction];
            shouldContinue = true;
            break;
          }
          temp[x - 1][y] = directionToSymbol[direction];
          temp[x][y] = "X";
          x--;
        }
        break;
      case "Down":
        while (isWithinBounds(x + 1, y, temp)) {
          if (visitedPositions.has(`${x},${y} -> ${direction}`)) return true;
          visitedPositions.add(`${x},${y} -> ${direction}`);
          if (temp[x + 1][y] === "#") {
            direction = turnDirecton(direction);
            temp[x][y] = directionToSymbol[direction];
            shouldContinue = true;
            break;
          }
          temp[x + 1][y] = directionToSymbol[direction];
          temp[x][y] = "X";
          x++;
        }
        break;
      case "Left":
        while (isWithinBounds(x, y - 1, temp)) {
          if (visitedPositions.has(`${x},${y} -> ${direction}`)) return true;
          visitedPositions.add(`${x},${y} -> ${direction}`);
          if (temp[x][y - 1] === "#") {
            direction = turnDirecton(direction);
            temp[x][y] = directionToSymbol[direction];
            shouldContinue = true;
            break;
          }
          temp[x][y - 1] = directionToSymbol[direction];
          temp[x][y] = "X";
          y--;
        }
        break;
      case "Right":
        while (isWithinBounds(x, y + 1, temp)) {
          if (visitedPositions.has(`${x},${y} -> ${direction}`)) return true;
          visitedPositions.add(`${x},${y} -> ${direction}`);
          if (temp[x][y + 1] === "#") {
            direction = turnDirecton(direction);
            temp[x][y] = directionToSymbol[direction];
            shouldContinue = true;
            break;
          }
          temp[x][y + 1] = directionToSymbol[direction];
          temp[x][y] = "X";
          y++;
        }
        break;
      case "Invalid":
        break;
      default:
        assertUnreachable(direction);
    }
  }
  return false;
};

export const day06b = (): number => {
  let counter = 0;
  const grid = create2DArray(input);

  for (let i = 0; i < grid.length; i++) {
    for (let j = 0; j < grid[i].length; j++) {
      const temp = grid[i][j];
      grid[i][j] = "#";
      if (isInLoop(grid)) counter++;
      grid[i][j] = temp;
    }
  }
  return counter;
};

const input = `#.............#.#...........................................................#..........#...........................#..........#...
............#......................#.......#..#.........#...................##....................................................
..............#...........#..#.......#.........#.#...........................#................................#......#............
.....#......................................#......#..#...................#....................#......................#...........
...#............................#................................#................................................................
..........#..................#.....#......................................................#.......................................
..#........#.......#.#...............................................................#......#.................................#...
.#....#................#................#.....#...................#...............................................#..#............
.......................................................................................#...#.#....#........##......#........#.#.##
............................................#.................#.....................#..........................#..................
....#..........##......................#.................................................................................#........
......#.............##.........#.......#.........#.......#.............#...#.......#..............................................
.#............................................................................#..........#....#...................................
...#..#....#..............................#...........................................................................#...........
.............#....................................................................................................................
................................#..................##...................................#...............................#......#..
..........#.........#.................#..........###...........................................#............#...#.................
.............#....................................#.......#.#.#............#............................................#.........
......#.#..............................................................................................#.........................#
...#...#.........#.........#..#......#................##.................#........................................................
.................................#......................#........#................#........................#......................
.......................##..............#................#................#..............................#.........................
.......#...#.....#.....##........................#..................##.....#......................................................
.............................................#...........................#..........................................#.....#.......
.........................#...............#....#..............#.......#...............#.#.................#.................#......
...........................................................#....#..................................#..............................
..........................#.................................................#............................##....#..................
.................#...#.........................................................#........................#.....#..#................
.........................#....#................................................#...#.....................#....#...........#.......
................................................##.......#.#....................................#.......##........................
..........##...#.......................#....#..#....................#........................#....................................
#......#.......................#............#.....................................................................#...............
.......#.......#...#..#..........#.......................................#.............#......#...................................
...............#............#..................#.................................................................................#
.......#...........#.......................##.....#.........#...........#...................#......#.........#.............##....#
...................#.........................#......#..........................................#..........#.........#......#......
.....#............#..............#...#......#....................#.............#..................................................
................................................#........#.....#...................#.....................................#.....#..
......................#.#...##......................##...............................................#.................#..........
#...................#.........................#...........#.....#................#.....................#...................#......
....#................#.....#.............#.....................................#....#...#.................................#.......
.........#.....................................................................................................#.#.......#........
.........#..........##..............................#............................#.#.............................#................
#....#.#..............................................##...#...#...............#.............#....................................
........#..#.#...................#.......................................................................#.............#..#.#...#.
.................................................................................................................#.......#........
............................................#..#...............##........#..........#.......................................#....#
........#...........................#............................#.....#........................#..........#...#..........#.......
.#...........#...................................................#...........................................#................#.#.
............#...............................#........#...........#..........#...........#.#..............#........................
...............................................................................##.#................#..............................
.#.......................#.#...........#..................................#.......................................................
..#..............................................##................#.......#....#..............#.....................#...#........
...................#.....#................................................#..........#.........#.........#.....................#..
........#................#................................................................................#......#................
...................#...#....#.........................#.........................#....................#..........................#.
.................#.......................................................#................................................#.......
..#...........................##.#.............#..#............................................#.......................#.#........
..#......#.........................................................................#.......................#......................
...........................................................................................................#............#......#..
............................................................^..........................................#..........#...............
..#.........#....................#..........................................#........#.........................................#..
........#...............#....#.............#......#.........................................................................#.....
.........#......#.....#..............#...........................................................#..............#.................
.........#...................................................#...###...........#.......#.##.......................................
.....................##.................#.........##.....................#................#................#.........#............
.......................................................................#..............#..............#.................#..........
.##.........#..........................................................................#....................................#.....
.........................#.............................#........................................................................#.
........#.............................................#......#....#.....................................#....................#....
........#...#..............................................................................#.........#............................
..............................#................................#..........#..............#..................................#.....
........##..#...................................#................................#.................#.........#......#..#........#.
..................#......#...................................................................#....................................
..........#.............#..............#........#............#...............#..#..........#..............#.#...#............#....
............................##....#..............#......................................................................#.........
...............................................#.....#...........#.....##...............#..#......................................
.........................#.......#...............................#...........#.........#...........#....#.........................
.#............#...#...............#..............................................................#..........................#....#
#...........#......................................................#.............................#......#.........................
..................................................#....#...............#.........................#................................
................................................#..........................#.......#..............................#....##.......#.
........#......#..#............#................#............................#......#.##.........#....................#..#........
.......................................................#..#.#....................#..#......................................#......
.....................#.......................................................................#............#.......................
.....................##........................#...................#.....................#........................................
..........................#...........................................................................................#...........
..#..........#...................#..............##..#.....................#...................#..............#...........#........
#................................#....##......#.............#..............#.......................#.........#...........#........
..................#................#...............................#.....#..........#................#..............#.............
................#.#.........#.....##...............................................................#..............#...............
..#...............................................................................................#...............................
..........#.................#...........#.......#.........................#...#.......#...........................................
..##....#......................................#.#.......................................#.................#......................
.......................#..#...#.##......................................................................#.........#...#...........
...............#.........#..............#.....................................................#...................#...............
......#.................#............#......#...................#..#.........................#........................#........#..
......................................................................#...........................#........#......................
..........#..........#........................#.............##....................................................................
....#................................................#.......................#................#...............#...................
.................#....................................................#......#....................................................
.#........#.......................................................................................................................
......##..................#....#......#.................#....................#.....................#..#...........#...............
#...#...#...#..............#........#.......................#.#..........#...............................#......#.................
#...#...................#.............#........#..........#...............................................................#...#...
..#................................#...#.........................#...................#......#.....................................
...#...###..........#............#...............................................................#..........#.....................
............#..............#.......#.....#..........#.....#.........................................................#............#
..#......................#..#...#................................#......#.......#.....#..................#.........#..............
....##......#.......................................................#..............................................#..............
...............................#.....#....#.................................................#.......#............#................
..........#....#......................#........#..........................#......#................................................
......#.............................#...........#..................#...........................#................................#.
...........................##..........................................#.....#.#.....................#................#...........
..#..............#.........................................................#........................#.........#.................#.
#.....#.....#......................#....................#........................................#...........#...........#......#.
.......................................#..#................................#.........#.......#..#.....#..........................#
..........#..............##...............#..........................................................#......#......#......#....#..
.............#..............#..#......#........#..#......##.......................#...........#.......#...........................
......................#.......................................#.......#..#.....................................#.........#...##...
...........................#...........................#......#....#.............................#.............................#..
..................#............................#....#........##.........................#..............#.............#............
.......#....................#.....#........#.......#.#...#...............#.....#.#.........................#.......#.#............
.....#.........#.......#..........#.................#..#...#..................................................##..................
................#........................................................#........................................................
....##......#........#..................#.........................#...................................#...#...................#...
..............#....................#.......#.......................#.............#......#..............#..........................
...........................#..............#.....#............#.....................#........#....#.......................#........
........#..##................#.....#.#..............#..............................#........................#.........#...........
.........................................................#...........................##..........#........#.##....................`;
